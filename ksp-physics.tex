\documentclass[11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[a4paper]{geometry}
\usepackage[pdfstartview=Fit,pdfpagelayout=SinglePage,breaklinks=true]{hyperref}
\usepackage{breakurl}
\usepackage{multicol}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage[final]{listings}
%\usepackage{makeidx}
\makeindex

\newcommand{\oa}[1]{\overrightarrow{#1}}
\newcommand{\F}[1]{\oa{F_{#1}}}
\newcommand{\Pos}{\oa{P}}
\newcommand{\Vel}{\oa{V}}
\newcommand{\absvec}[1]{\left|\left|{#1}\right|\right|}
\newcommand{\dddvec}[3]{\left(\begin{smallmatrix}{#1}\\{#2}\\{#3}\end{smallmatrix}\right)}
\begin{document}

\title{Documentation of KSP Physics\\\small{Version \input{.tagversion}}}
\author {Mhoram Kerbin \href{mailto:mhoram.kerbin@gmx.de}{\nolinkurl{mhoram.kerbin@gmx.de}}}

\maketitle

\begin{abstract}

  This documents summarizes the physics of Kerbal Space Program
  \cite{KSP}. It should be valid for versions 0.21 to 0.24.2.

\end{abstract}

\tableofcontents

\section{Introduction}

During my attempts to use PSOPT as a method for generating ideal
ascent trajectories for rockets, I needed to implement the physics of
KSP in C/C++. So I had to gather all the physics related information
again after my Ascent Optimizer Perl-project \cite{PAO}. Since they
are available at quite different places, this document should
summarize them in a central place.

\section{Conventions}

We denote by $\Pos$, $\Vel$, $d$ and $M$ the position vector, velocity
vector, drag coefficient and the mass of the ship respectively.

$\Pos_X, \Pos_Y \textrm{ and } \Pos_Z$ denote the X, Y and Z
components of the vector.

Distance denotes the distance to the planets center and altitude the
distance to the surface sea level.

\section{Physical Constants}


\subsection{Global Constants}

The \index{conversion factor} conversion factor between pressure and
density is according to \cite{Atmo}.

\begin{align}
  CF &:= 1.2230948554874 \frac{kg}{m^3\cdot atm}
\end{align}

The \index{gravitational constant} gravitational constant $G$ is according to \cite{ACB}.
\begin{align}
  G &:= 6.674E-11 N\left(\frac{m}{kg}\right)^2
\end{align}

\subsection{Planets}

Planets are defined with respect to this problem setting by the
following constants

\begin{itemize}
\item Name
\item \index{Mass of Planet} Mass of Planet $PMass^{(Name)}$ in kg
\item \index{Planetary Radius} Planetary Radius $PRadius^{(Name)}$ in m
\item \index{Scale Height} Scale Height $PSH^{(Name)}$ in m
\item \index{Density at Sealevel} Density at Sealevel $p_0^{(Name)}$ in atm
\item \index{Rotation Period} Rotation Period $RP^{(Name)}$ in s
\item \index{Spehre of Influence} Radius of Spehre of Influence $Soi^{(Name)}$ in m
\end{itemize}

\subsubsection{Kerbin}

This information is based on \cite{Kerbin}.

\begin{align*}
  PMass^{(Kerbin)} &:= 5.2915793E22 kg\\
  PRadius^{(Kerbin)} &:= 600000 m\\
  PSH^{(Kerbin)} &:= 5000 m\\
  p_0^{(Kerbin)} &:= 1 atm\\
  RP^{(Kerbin)} &:= 21600 s\\
  Soi^{(Kerbin)} &:= 84159286 m\\
\end{align*}

\section{Atmosphere}

Now we will show how several atmospheric parameters are calculated
based on \cite{Atmo}.
\begin{align}
  \textrm{AtmosphericHeight}\nonumber\\
  AH^{(Name)} &:= -ln\left(10^{-6}\right)\cdot PSH^{(Name)}\\
  \textrm{Pressure at altitude }&\nonumber\\
  p(alt) &:=
  \left\{
      \begin{array}{l l}
        p_0^{(Name)} \cdot exp\left({\frac{-alt}{PSH^{(Name)}}}\right) & \textrm{if } alt < AH^{(Name)}\\
        0 &\textrm{if } alt \geq AH^{(Name)}
      \end{array}
    \right.\\
    \textrm{Density at altitude}\nonumber\\
    \rho(alt) &:= CF \cdot p(alt)
\end{align}

\section{Latitude and Longitude conversion}

From a Position Vector $\Pos$ we can calculate latitude
and longitude by the following formula:

\begin{align}
  Lon(\Pos) &:= atan\left(\frac{\Pos_Y}{\Pos_X}\right)\\
  Lat(\Pos) &:= atan\left(\frac{\Pos_Z}{\sqrt{\Pos_X^2+\Pos_Y^2}}\right)
\end{align}

\section{Surface Velocity}

Due to the rotation of the planet, the surface velocity is different from
the orbital speed.

The difference between the two speed vectors $DiffV(\Pos)$ is the
projected earth rotation to the position $\Pos$ of the rocket.

We can convert orbital $\Vel$ to surface velocity $\oa{SV}$
vectors with the following equation.

\begin{align}
  DiffV(\Pos) &:= \absvec{\Pos} \cdot \frac{2 \pi}{RP^{(Name)}} \cdot cos\left(Lat\left(\Pos\right)\right)\cdot\left(\begin{smallmatrix}-sin(Lon(\Pos)\\cos(Lon(\Pos))\\0\end{smallmatrix}\right)\\
  \oa{SV} &:= \Vel - DiffV(\Pos)
\end{align}

\section{Drag Coefficient}

In KSP $d$ is the drag coefficient of the rocket. It is a mass-based
average of the drag coefficients of all parts of the rocket and is
dimensionless.

Usually it is near to $0.2$.

Consider a rocket consisting of a Mk1 Cockpit, a FL-T800 Fuel Tank and
a LV-909 Liquid Fuel Engine. For this rocket the drag coefficient is:
\begin{align}
  d &= \frac{1.25 \cdot 0.1 + 4.5 \cdot 0.2 + 0.5 \cdot 0.2}{ 1.25 + 4.5 + 0.5 }\nonumber\\
  &= \frac{1.125}{6.25}\nonumber\\
  &= 0.18\nonumber
\end{align}

\section{Drag}

Drag is the force applied to rocket based on the movement through the
atmosphere it is directed in an opposite direction to the movement.

Since it is directly proportional to the cross-sectional area $A$ of
the rocket and this value is approximated in KSP by $A = 0.008
\frac{m^2}{kg} \cdot M$ we get

\begin{align}
  \F{D} &:= - 0.5 \cdot \rho(alt)\cdot \absvec{\oa{SV}}^2\cdot d \cdot 0.008\frac{m^2}{kg} \cdot M \cdot \frac{\oa{SV}}{\absvec{\oa{SV}}} \nonumber\\
  &= - 0.5 \cdot \rho(alt)\cdot d \cdot 0.008\frac{m^2}{kg} \cdot M \cdot \absvec{\oa{SV}} \cdot \oa{SV}
\end{align}

\section{Lift}

Lift is a bit more complex. The best description of lift can be found in the ``How to calculate lift?'' thread \cite{Lift}

\section{Gravity}

The gravity force is directed towards the planets core and gets lower
with increasing distance.

\begin{align}
  \mu^{(Name)} = LocalGravityParameter^{(Name)} &:= G \cdot PMass^{(Name)} \nonumber\\
  LocalGravity(distance) &:= \frac{LocalGravityParameter}{distance^2}\nonumber\\
  \F{G} &:= - M \cdot \mu^{(Name)}\cdot\frac{\Pos}{\absvec{\Pos}^3}
\end{align}

\section{Acceleration}

The rocket is subect to the three forces drag $\F{D}$, gravity $\F{G}$
and thrust $\F{T}$.  The acceleration vector $\oa{a}$ based on these
three forces is:

\begin{align}
  \oa{a} &:= M^{-1} \cdot(\F{D} + \F{G} + \F{T})
\end{align}

\section{Engines}

\subsection{Rocket Engines}

The Specific impulse $I_{SP}$ (in seconds) describes the engine
efficiency and is parameterized for an engine by ISP at sealevel and
ISP in vacuum.

The ISP is linear in the pressure $p$ and cut off at $1atm$
(citation needed).  We can calculate the ISP based on the pressure
$p$ by
\begin{align}
  np(p) &:= min(1 atm, p)\\
  ISP(p) &:= ISP_{1atm} \cdot np(p) + ISP_{VAC} \cdot (1-np(p))
\end{align}

According to \cite{ECF} the conversion factor $g_0$ is not
$9.81\frac{m}{s^2}$, but
\begin{align}
  g_0 &\approx 9.82\frac{m}{s^2}
\end{align}

So we get a fuel consumption $\dot{m}$ (change of mass) \cite{SPI} of:
\begin{align}
\dot{m} & := \frac{\absvec{\oa{F_T}}}{ISP \cdot g_0}
\end{align}

\subsection{Jet Engines}

Jet Engines are described in a nonlinear way. Details can be found in
the ``Fuel consumption as a function of atmospheric pressure`` thread
\cite{JetEngines}

\subsection{ISP Calculation}

A ship with multiple engines that have different ISP-profiles has an
averaged ISP that is based on the ISP of all running engines.

The calculation of the ships ISP is described on the wiki
\cite{MulEng}.

A ship with $n$ running engines, where each engine $i$ has a thrust of
$F_{T_i}$ and a specific impulse of $I_{SP_i}$ has a total ISP of:

\begin{align}
  I_{SP} := \frac{\sum_i{F_{T_i}}}{\sum_i{\frac{F_{T_i}}{I_{SP_i}}}}
\end{align}


\section{Coordinate Conversion}

An Orbit can be described either by cartesian coordinates of a
position vector $\Pos$ and a velocity vector $\Vel$ or by kepler
elements \cite{Kepler}

\begin{itemize}
\item Semimajor axis ($a$)
\item Eccentricity ($e$)
\item Inclination ($i$)
\item Longitude of the ascending node ($\Omega$)
\item Argument of periapsis ($\omega$)
\item True Anomaly ($\nu$)
\end{itemize}

This section contains a description of the conversion between Kepler
and Cartesian coordinates.

\subsection{Cartesian to Kepler}

We can convert cartesian to kepler coordinates by the following
equations courtesy of \cite{RSCK}, where $\mu^{(Name)}$ denotes the
gravitational Parameter of the planet, $\oa{h}$ the orbital momentum
vector and $\oa{e}$ the eccentricity vector.

\begin{align}
  \oa{h} &:= \Pos \times \Vel\nonumber\\
  a &:= \left(2\cdot\absvec{\Pos}^{-1} - \frac{\absvec{\Vel}^2}{\mu^{(Name)}}\cdot \right)^{-1}\\
  \oa{e} &:= \frac{\Vel\times \oa{h}}{\mu^{(Name)}} - \absvec{\Pos}\nonumber\\
  e &:= \absvec{\oa{e}}\\
  i &:= arccos\left(\frac{\oa{h}_Z}{\absvec{\oa{h}}} \right)\\
  \oa{n} & := \dddvec{0}{0}{1} \times \oa{h} = \dddvec{-\oa{h}_Y}{\oa{h}_X}{0}\nonumber\\
  \Omega &:= \left\{
    \begin{array}{l l}
      0 & \textrm{if } \absvec{\oa{n}} = 0\\
      arccos\left(\dddvec{1}{0}{0}\cdot\frac{\oa{n}}{\absvec{\oa{n}}} \right) & \textrm{if } \oa{n}_Y = \oa{h}_X >= 0\\
      2\pi - arccos\left(\dddvec{1}{0}{0}\cdot\frac{\oa{n}}{\absvec{\oa{n}}} \right) & \textrm{otherwise}
    \end{array}
    \right.\\
  \omega & := \left\{
    \begin{array}{l l}
      0 & \textrm{if } \absvec{\oa{n}} = 0\\
      arccos\left(\frac{\oa{n}\cdot\oa{e}}{\absvec{\oa{n}}\cdot\absvec{\oa{e}}} \right) & \textrm{if } \oa{e}_Z >= 0\\
      2\pi - arccos\left(\frac{\oa{n}\cdot\oa{e}}{\absvec{\oa{n}}\cdot\absvec{\oa{e}}}\right) & \textrm{otherwise}
    \end{array}
    \right.\\
    \nu &:= \left\{
    \begin{array}{l l}
      arccos\left(\frac{\Pos\cdot\oa{e}}{\absvec{\Pos}\cdot\absvec{\oa{e}}}\right) & \textrm{if } \Pos\cdot\Vel >= 0\\
      2\pi - arccos\left(\frac{\Pos\cdot\oa{e}}{\absvec{\Pos}\cdot\absvec{\oa{e}}}\right) & \textrm{otherwise}
    \end{array}
    \right.
\end{align}

\subsection{Kepler to Cartesian}

We als can convert kepler to cartesian coordinates by the following
equations courtesy of \cite{RSKC}.

We first calculate the eccentric Anomaly $E$ by the formula $M = E -
e\cdot sin(E)$. Since this equation does not have a closed-form
solution for $E$, we use the Newton-Raphson method to approximate the
solution.
%\begin{align}
%  \textrm{Set } Temp := \left\{
%    \begin{array}{l l}
%      \pi & \textrm{if } e > 0.8\\
%      M
%\end{align}



\begin{align}
  \absvec{\oa{o}} & := a(1-e \cdot cos(E))\\
  \oa{o} & := \absvec{\oa{o}} \dddvec{cos(\nu)}{sin(\nu)}{0}\\
  \Pos & := \dddvec{1}{2}{3} TO BE DONE
\end{align}


\section{Orbital Mechanics}

We can calculate the apoapsis $Apo$ and periapsis $Peri$ as

\begin{align}
Apo & := a \cdot (1 + e)\\
Peri & := a \cdot (1 - e)
\end{align}

Conversely we can calculate the eccentricity and semi-major as

\begin{align}
  a & := \frac{1}{2}\cdot(Apo + Peri)\\
  e & := \frac{Apo}{a} - 1\\
  e & := 1 - \frac{Peri}{a}
\end{align}

The speed of an object that orbits a Body at both Apsides is

\begin{align}
V_{Apo} & := \sqrt{\mu^{(Body)} \cdot \left(\frac{2}{Apo} - \frac{1}{a}\right)}\\
V_{Peri} & := \sqrt{\mu^{(Body)} \cdot\left(\frac{2}{Peri} - \frac{1}{a}\right)}
\end{align}

In the case of a circular orbit, they are equal.

The orbital period (with the meaning of sidereal period \cite{SIDPER}) around a Body is

\begin{align}
SiderealPeriod := 2\pi\sqrt{\frac{a^3}{\mu^{(Body)}}}
\end{align}



\begin{thebibliography}{Kerbin}

\bibitem{KSP}
  \url{http://kerbalspaceprogram.com/}

\bibitem{PAO}
  \url{https://github.com/mhoram-kerbin/ascent-optimizer}

\bibitem{Atmo}
  \url{http://wiki.kerbalspaceprogram.com/wiki/Atmosphere}

\bibitem{ACB}
  \url{http://wiki.kerbalspaceprogram.com/wiki/API:CelestialBody}

\bibitem{Kerbin}
  \url{http://wiki.kerbalspaceprogram.com/wiki/Kerbin}

\bibitem{ECF}
  \url{http://wiki.kerbalspaceprogram.com/wiki/Specific_impulse#Conversion_factor}

\bibitem{Kepler}
  \url{http://en.wikipedia.org/wiki/Kepler_orbit}

\bibitem{RSCK}
  \url{https://downloads.rene-schwarz.com/dc/category/20}

\bibitem{RSKC}
  \url{https://downloads.rene-schwarz.com/dc/category/19}

\bibitem{SPI}
  \url{http://wiki.kerbalspaceprogram.com/wiki/Specific_impulse#Formula}

\bibitem{SIDPER}
  \url{http://en.wikipedia.org/wiki/Sidereal_period}

\bibitem{MulEng}
  \url{http://wiki.kerbalspaceprogram.com/wiki/Specific_impulse#Multiple_engines}

\bibitem{Lift}
  \url{http://forum.kerbalspaceprogram.com/threads/29788-How-to-calculate-lift}

\bibitem{JetEngines}
  \url{http://forum.kerbalspaceprogram.com/threads/67606-Fuel-consumption-as-a-function-of-atmospheric-pressure}

\end{thebibliography}

\end{document}

% Local Variables:
% ispell-local-dictionary:"american";
% End:

